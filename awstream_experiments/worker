#!/usr/bin/env bash
set -e

function usage() {
    cat <<EOF
Usage:
./worker start
./worker stop
EOF
}

PID_DIR=/tmp/jetstream
mkdir -p ${PID_DIR}

function start() {
    ## Retrieve and set variables
    JS=`dirname $0`/..
    CFG="-C worker.conf"
    LOGNAME=/tmp/jetstream/log
    CMD="${JS}/jsnoded --start ${CFG}"

    export LD_LIBRARY_PATH=${JS}/lib

    ## Kill previous run
    if [ -f ${PID_DIR}/jsnode.pid ]; then
	echo "Killing previous run"
	kill `cat ${PID_DIR}/jsnode.pid`
    fi

    ## Print information and run
    echo "logging to ${LOGNAME}; libpath is ${LD_LIBRARY_PATH}"
    echo "running ${CMD}"
    nohup ${CMD} $@ >$LOGNAME 2>&1 &
    PID=$!
    echo $PID > ${PID_DIR}/jsnode.pid
    echo "started; pid is ${PID}"
    sleep 1
}

function stop() {
    kill `cat ${PID_DIR}/jsnode.pid`
    rm ${PID_DIR}/jsnode.pid
}

function main() {
    case $1 in
        start)
	    start
	    ;;
	stop)
	    stop
	    ;;
	*)
            usage
    esac
}

main "$@" || exit 1
